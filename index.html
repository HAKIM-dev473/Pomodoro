<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Study Timer â€” Reliable</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,Arial,sans-serif;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;
      padding:24px;
    }
    .card{
      width:100%;
      max-width:520px;
      background:rgba(255,255,255,0.08);
      border-radius:16px;
      padding:28px;
      text-align:center;
      backdrop-filter:blur(8px);
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.08);
    }
    h1{font-size:1.6rem;margin-bottom:18px}
    .controls{display:flex;gap:12px;justify-content:center;align-items:center}
    input[type=number]{
      width:120px;padding:10px;border-radius:10px;border:none;
      text-align:center;font-size:1rem;background:rgba(255,255,255,0.06);color:#fff;
      outline:none;
    }
    button{
      padding:10px 16px;border-radius:10px;border:2px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);color:#fff;font-weight:600;cursor:pointer;
      transition:transform .15s,background .15s;
    }
    button:active{transform:translateY(1px)}
    .timer{
      margin-top:20px;font-size:3rem;font-weight:700;text-shadow:0 6px 18px rgba(0,0,0,.45)
    }
    .status{margin-top:8px;opacity:.9}
    .bottom{margin-top:18px;display:flex;gap:12px;justify-content:center;align-items:center}
    .stats{
      margin-top:16px;background:rgba(0,0,0,0.25);padding:10px 14px;border-radius:10px;
      display:inline-block;border:1px solid rgba(255,255,255,0.06)
    }
    @media (max-width:420px){
      .timer{font-size:2.2rem}
      input[type=number]{width:88px}
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸŽ¯ Reliable Study Timer</h1>

    <div class="controls">
      <input id="minutesInput" type="number" min="1" placeholder="Minutes" />
      <button id="startBtn">Start</button>
      <button id="cancelBtn">Cancel</button>
    </div>

    <div class="timer" id="timerDisplay">00:00</div>
    <div class="status" id="status">Enter minutes and click Start.</div>

    <div class="bottom">
      <div class="stats">Total Today: <strong id="totalDisplay">0 min</strong></div>
    </div>
  </div>

  <script>
    // Elements
    const minutesInput = document.getElementById('minutesInput');
    const startBtn = document.getElementById('startBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const status = document.getElementById('status');
    const totalDisplay = document.getElementById('totalDisplay');

    // State
    let endTime = null;          // timestamp in ms when session ends
    let startedMinutes = 0;      // original minutes entered (for storing total)
    let tickTimer = null;        // interval id
    const TICK_MS = 500;         // update interval (500ms is fine)
    const STORAGE_TOTAL_KEY = 'study_total_minutes';
    const STORAGE_SESSION_KEY = 'study_active_session'; // JSON: {endTime, startedMinutes}

    // Sound (small beep)
    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        g.gain.value = 0.18;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close().catch(()=>{}); }, 350);
      } catch (e){ /* ignore */ }
    }

    // Utils
    function formatSeconds(sec){
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function loadTotal(){
      const t = parseInt(localStorage.getItem(STORAGE_TOTAL_KEY) || '0', 10);
      totalDisplay.textContent = `${t} min`;
      return t;
    }

    function saveTotal(addMinutes){
      const cur = loadTotal();
      const next = cur + addMinutes;
      localStorage.setItem(STORAGE_TOTAL_KEY, String(next));
      totalDisplay.textContent = `${next} min`;
    }

    function persistSession(){
      if (endTime){
        localStorage.setItem(STORAGE_SESSION_KEY, JSON.stringify({
          endTime,
          startedMinutes
        }));
      } else {
        localStorage.removeItem(STORAGE_SESSION_KEY);
      }
    }

    function restoreSession(){
      const raw = localStorage.getItem(STORAGE_SESSION_KEY);
      if (!raw) return false;
      try{
        const obj = JSON.parse(raw);
        if (obj && obj.endTime && obj.startedMinutes){
          // If endTime already passed, clear it (we will complete below)
          endTime = obj.endTime;
          startedMinutes = obj.startedMinutes;
          // If the endTime is already in the past, run completion immediately on next tick
          startTick();
          return true;
        }
      }catch(e){}
      return false;
    }

    function updateTitle(txt){
      try { document.title = txt + " â€” Study Timer"; } catch(e){}
    }

    // Core update loop (based on timestamps)
    function tick(){
      if (!endTime){
        updateTitle('Idle');
        return stopTick();
      }
      const msLeft = endTime - Date.now();
      const secLeft = Math.max(0, Math.ceil(msLeft / 1000));
      timerDisplay.textContent = formatSeconds(secLeft);

      updateTitle(timerDisplay.textContent);

      if (msLeft <= 0){
        // session finished
        finishSession();
      }
    }

    function startTick(){
      if (tickTimer) return;
      tick(); // immediate update
      tickTimer = setInterval(tick, TICK_MS);
    }
    function stopTick(){
      if (tickTimer){ clearInterval(tickTimer); tickTimer = null; }
    }

    // Start a new session
    function startSession(minutes){
      if (typeof minutes !== 'number' || minutes <= 0) return;
      startedMinutes = minutes;
      endTime = Date.now() + minutes * 60_000;
      persistSession();
      startBtn.disabled = true;
      minutesInput.disabled = true;
      status.textContent = 'Focus mode â€” timer running';
      startTick();
    }

    // Cancel current session (allows user to start a new one)
    function cancelSession(){
      endTime = null;
      startedMinutes = 0;
      persistSession();
      stopTick();
      timerDisplay.textContent = '00:00';
      minutesInput.disabled = false;
      startBtn.disabled = false;
      status.textContent = 'Session canceled. Enter minutes to start again.';
      updateTitle('Idle');
    }

    // Called when session finishes naturally
    function finishSession(){
      stopTick();
      // record total minutes (use the original minutes user entered)
      if (startedMinutes && startedMinutes > 0){
        saveTotal(startedMinutes);
      }
      // clear saved session
      endTime = null;
      startedMinutes = 0;
      persistSession();
      // UI
      timerDisplay.textContent = '00:00';
      minutesInput.disabled = false;
      startBtn.disabled = false;
      status.textContent = 'Session complete! Enter new time to start again.';
      updateTitle('Session complete');
      beep();
      // briefly flash the document title and send a visible notification if supported
      try {
        if (Notification && Notification.permission === 'granted'){
          new Notification('Study session finished âœ…', { body: 'Good job! Enter a new time to continue.' });
        } else if (Notification && Notification.permission !== 'denied'){
          Notification.requestPermission().then(p => {
            if (p === 'granted') new Notification('Study session finished âœ…', { body: 'Good job! Enter a new time to continue.' });
          });
        }
      } catch(e){}
    }

    // Event handlers
    startBtn.addEventListener('click', () => {
      if (startBtn.disabled) return;
      const val = parseInt(minutesInput.value, 10);
      if (!val || val <= 0){
        status.textContent = 'Please enter a valid minute value (â‰¥1).';
        return;
      }
      startSession(val);
    });

    cancelBtn.addEventListener('click', cancelSession);

    // Visibility change: force an immediate tick when user comes back to tab
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) tick();
    });

    // restore session on load if exists
    window.addEventListener('load', () => {
      loadTotal();
      const resumed = restoreSession();
      if (resumed){
        // if resumed and session already passed, tick() will handle completion quickly
        status.textContent = 'Resumed active session';
      }
      // show initial display (if no session)
      if (!endTime) timerDisplay.textContent = '00:00';
    });

    // save session before unload (so closing tab keeps it)
    window.addEventListener('beforeunload', () => {
      persistSession();
    });

  </script>
</body>
</html>
